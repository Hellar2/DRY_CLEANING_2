<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login</title>
  <link rel="stylesheet" href="main.css" />
  <style>
    .demo-btn {
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .demo-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      opacity: 0.9;
    }
    .demo-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .demo-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Password toggle styles */
    .password-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    
    .password-container input {
      width: 100%;
      padding-right: 45px; /* Space for the toggle button */
    }
    
    .password-toggle {
      position: absolute;
      right: 10px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    
    .password-toggle:hover {
      background-color: #f0f0f0;
    }
    
    .eye-icon {
      font-size: 16px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Login</h2>

    <form id="loginForm">
      <label for="identifier">Email or Phone</label>
      <input id="identifier" name="identifier" type="text" required />
      <label for="password">Password</label>
      <div class="password-container">
        <input id="password" name="password" type="password" required />
        <button type="button" class="password-toggle" onclick="togglePassword('password')">
          <span class="eye-icon">üëÅÔ∏è</span>
        </button>
      </div>
      <button type="submit">Login</button>
      
      <p>Don't have an account? <a href="signup.html">Register here</a></p>
      <p><a href="#" id="forgotPasswordLink">Forgot Password?</a></p>
    </form>
  </div>

  <!-- ===== Forgot Password Modal ===== -->
  <div id="forgotModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2>Reset Password</h2>

      <label for="resetIdentifier">Email or Phone</label>
      <input type="text" id="resetIdentifier" placeholder="Enter your email or phone" required />

      <label for="newPassword">New Password</label>
      <div class="password-container">
        <input type="password" id="newPassword" placeholder="Enter new password" required />
        <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
          <span class="eye-icon">üëÅÔ∏è</span>
        </button>
      </div>

      <button id="resetBtn">Reset Password</button>
    </div>
  </div>

  <script>
    // Set backend base URL
    const API_BASE = 'http://localhost:5002';
    
    // Demo account credentials (hardcoded)
    const DEMO_ACCOUNTS = {
      admin: {
        identifier: 'admin@dryclean.com',
        password: 'admin123'
      },
      staff: {
        identifier: 'staff@dryclean.com',
        password: 'staff123'
      },
      customer: {
        identifier: 'customer@dryclean.com',
        password: 'customer123'
      }
    };

    // Demo login button handlers
    document.querySelectorAll('.demo-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const role = e.target.dataset.role;
        const credentials = DEMO_ACCOUNTS[role];
        
        if (!credentials) {
          alert('Demo account not configured');
          return;
        }
        
        // Fill in the form fields
        document.getElementById('identifier').value = credentials.identifier;
        document.getElementById('password').value = credentials.password;
        
        // Show loading state
        e.target.disabled = true;
        e.target.textContent = 'Logging in...';
        
        // Perform login
        await performLogin(credentials.identifier, credentials.password);
        
        // Reset button
        e.target.disabled = false;
        e.target.textContent = e.target.textContent.replace('Logging in...', role.charAt(0).toUpperCase() + role.slice(1));
      });
    });
    
    const form = document.getElementById('loginForm');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const identifier = document.getElementById('identifier').value.trim();
      const password = document.getElementById('password').value;
      
      await performLogin(identifier, password);
    });
    
    // Shared login function
    async function performLogin(identifier, password) {
      if (!identifier || !password) {
        alert("Please enter both email/phone and password");
        return;
      }

      console.log('üîê Attempting login with:', { identifier, passwordLength: password.length });

      try {
        const res = await fetch(`${API_BASE}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ identifier, password })
        });

        // Safely parse JSON only if response has JSON content-type
        const contentType = res.headers.get('content-type') || '';
        let data = null;
        if (contentType.includes('application/json')) {
          data = await res.json();
        } else {
          const text = await res.text();
          // try to parse text as JSON fallback
          try { data = text ? JSON.parse(text) : null; } catch (e) { data = { message: text || 'Unexpected response' }; }
        }

         if (!res.ok) {
          const msg = data?.message || `Login failed (HTTP ${res.status}). Make sure the backend is running on port 5002.`;
          alert(msg);
          console.error('Login failed:', { status: res.status, data });
          return;
         }

         // Save session info including auth token
         localStorage.setItem('authToken', data.token);
         localStorage.setItem('userId', data.userId);
        localStorage.setItem('role', data.role || '');
        localStorage.setItem('fullname', data.fullname || '');
        
        // For staff dashboard
        if (data.role === 'Staff') {
          localStorage.setItem('staffUser', JSON.stringify({
            name: data.fullname,
            email: identifier,
            role: data.role
          }));
        }

        console.log('‚úÖ Login successful:', { role: data.role, token: data.token ? 'Present' : 'Missing' });

        const role = (data.role || '').toLowerCase();
        if (role === 'admin' || role === 'administrator') {
          // Use relative paths so files under the `frontend/` folder resolve correctly
          window.location.href = './admindashboard.html';
        } else if (role === 'staff') {
          window.location.href = './staff-Dashboard.html';
        } else {
          window.location.href = './cdashboard.html';
        }
      } catch (err) {
        console.error('Login fetch error', err);
        alert('Network error during login');
      }
    }

    // ===== FORGOT PASSWORD MODAL =====
    const modal = document.getElementById("forgotModal");
    const openModal = document.getElementById("forgotPasswordLink");
    const closeModal = document.getElementById("closeModal");
    const resetBtn = document.getElementById("resetBtn");

    openModal.onclick = (e) => { e.preventDefault(); modal.style.display = "block"; };
    closeModal.onclick = () => modal.style.display = "none";
    window.onclick = (event) => { if (event.target === modal) modal.style.display = "none"; };

    // ===== RESET PASSWORD FUNCTION =====
    resetBtn.addEventListener("click", async () => {
      const identifier = document.getElementById("resetIdentifier").value.trim();
      const newPassword = document.getElementById("newPassword").value.trim();

      if (!identifier || !newPassword) {
        alert("Please fill in all fields.");
        return;
      }

      resetBtn.disabled = true;
      resetBtn.textContent = "Resetting...";

      try {
        const res = await fetch(`${API_BASE}/api/auth/reset-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ identifier, newPassword })
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.message || "Password reset failed.");
          return;
        }

        alert(data.message || "Password reset successful!");
        modal.style.display = "none";
        document.getElementById("resetIdentifier").value = "";
        document.getElementById("newPassword").value = "";

      } catch (err) {
        console.error("Reset fetch error:", err);
        alert("Network error or server unreachable.");
      } finally {
        resetBtn.disabled = false;
        resetBtn.textContent = "Reset Password";
      }
    });
    
    // Toggle password visibility
    function togglePassword(inputId) {
      const passwordInput = document.getElementById(inputId);
      const eyeIcon = passwordInput.nextElementSibling.querySelector('.eye-icon');
      
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.textContent = 'üôà';
      } else {
        passwordInput.type = 'password';
        eyeIcon.textContent = 'üëÅÔ∏è';
      }
    }
  </script>
</body>
</html>
