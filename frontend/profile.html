<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile - Dry Cleaning Service</title>
<link rel="stylesheet" href="profile.css">
<style>
    .profile-page-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .profile-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 0;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .profile-header {
        text-align: center;
        padding: 40px 30px 30px;
        color: white;
        position: relative;
    }

    .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: white;
        margin: 0 auto 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        font-weight: bold;
        color: #667eea;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .profile-name {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .profile-role {
        font-size: 16px;
        opacity: 0.9;
        font-weight: 500;
    }

    .profile-body {
        background: white;
        padding: 40px;
    }

    .profile-info-section {
        margin-bottom: 30px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #ecf0f1;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 25px;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .info-label {
        font-size: 13px;
        font-weight: 600;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 16px;
        color: #2c3e50;
        font-weight: 600;
        padding: 12px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }

    .info-value:hover {
        background: #e9ecef;
        transform: translateX(3px);
    }

    .info-value::after {
        content: '‚úèÔ∏è';
        position: absolute;
        right: 15px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .info-value:hover::after {
        opacity: 0.6;
    }

    .info-value input {
        width: 100%;
        border: none;
        background: transparent;
        font-size: 16px;
        color: #2c3e50;
        font-weight: 600;
        padding: 0;
        outline: none;
    }

    .info-value.editing {
        background: white;
        border-left-color: #27ae60;
        box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
    }

    .info-value.editing::after {
        content: 'üíæ';
        opacity: 1;
    }

    .save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: none;
        animation: slideIn 0.3s ease;
    }

    .save-indicator.show {
        display: block;
    }

    .save-indicator.error {
        background: #e74c3c;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-top: 30px;
    }

    .stat-box {
        background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        border: 2px solid #667eea30;
    }

    .stat-number {
        font-size: 32px;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 13px;
        color: #7f8c8d;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 5px;
    }

    .badge-verified {
        background: #27ae60;
        color: white;
    }

    .badge-pending {
        background: #f39c12;
        color: white;
    }

    @media (max-width: 768px) {
        .profile-body {
            padding: 25px;
        }
        
        .info-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body>
<div class="dashboard-container">
    <nav class="sidebar">
        <h2 class="logo">DRY CLEANING</h2>
        <ul class="nav-menu">
            <li><a href="cdashboard.html">Dashboard</a></li>
            <li><a href="myOrders.html">My Orders</a></li>
            <li class="active"><a href="profile.html">Profile</a></li>
            <li><a href="payment-history.html">Payment History</a></li>
            <li><a href="settings.html">Settings</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <!-- Save Indicator -->
        <div class="save-indicator" id="saveIndicator">
            <span id="saveMessage">‚úì Saved successfully!</span>
        </div>

        <div class="profile-page-container">
            <div class="profile-card">
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">
                        <span id="avatarInitials">?</span>
                    </div>
                    <div class="profile-name" id="profileDisplayName">Loading...</div>
                    <div class="profile-role" id="profileDisplayRole">Customer</div>
                    <div id="verificationBadge"></div>
                </div>

                <!-- Profile Body -->
                <div class="profile-body">
                    <!-- Personal Information -->
                    <div class="profile-info-section">
                        <h3 class="section-title">üìã Personal Information</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Full Name</span>
                                <div class="info-value editable" id="displayFullName" data-field="fullName" onclick="makeEditable(this)">Loading...</div>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email Address</span>
                                <div class="info-value editable" id="displayEmail" data-field="email" onclick="makeEditable(this)">Loading...</div>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phone Number</span>
                                <div class="info-value editable" id="displayPhone" data-field="phone" onclick="makeEditable(this)">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Account Statistics -->
                    <div class="profile-info-section">
                        <h3 class="section-title">üìä Account Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-number" id="totalOrders">0</div>
                                <div class="stat-label">Total Orders</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="activeOrders">0</div>
                                <div class="stat-label">Active Orders</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-number" id="completedOrders">0</div>
                                <div class="stat-label">Completed</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
const API_BASE = 'http://localhost:5002';
const userId = localStorage.getItem('userId');

if(!userId){
    alert("You must be logged in to view your profile.");
    window.location.href = "login.html";
}

// Get initials from name
function getInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name.substring(0, 2).toUpperCase();
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

// Store current profile data
let currentProfile = {};

// Load profile from backend
async function loadProfile() {
    try {
        console.log('Loading profile for userId:', userId);
        const res = await fetch(`${API_BASE}/api/customer/${userId}`);
        
        if (!res.ok) {
            const errorData = await res.json().catch(() => ({ message: 'Failed to fetch profile' }));
            throw new Error(errorData.message || 'Failed to fetch profile');
        }
        
        const data = await res.json();
        console.log('Profile data loaded:', data);

        // Store current profile data
        currentProfile = {
            fullName: data.fullName,
            email: data.email,
            phone: data.phone
        };

        // Update avatar initials
        const initials = getInitials(data.fullName);
        document.getElementById('avatarInitials').textContent = initials;

        // Update header
        document.getElementById('profileDisplayName').textContent = data.fullName || 'N/A';
        document.getElementById('profileDisplayRole').textContent = data.role || 'Customer';

        // Update verification badge
        const badgeDiv = document.getElementById('verificationBadge');
        if (data.isVerified) {
            badgeDiv.innerHTML = '<span class="badge badge-verified">‚úì Verified Account</span>';
        } else {
            badgeDiv.innerHTML = '<span class="badge badge-pending">‚è≥ Pending Verification</span>';
        }

        // Update personal information
        document.getElementById('displayFullName').textContent = data.fullName || 'N/A';
        document.getElementById('displayEmail').textContent = data.email || 'N/A';
        document.getElementById('displayPhone').textContent = data.phone || 'N/A';

        // Update localStorage
        localStorage.setItem('fullname', data.fullName || '');
        
        // Load order statistics
        loadOrderStats();
        
    } catch (err) {
        console.error('Error loading profile:', err);
        document.getElementById('profileDisplayName').textContent = 'Error loading profile';
    }
}

// Make field editable on click
function makeEditable(element) {
    if (element.classList.contains('editing')) return;

    const currentValue = element.textContent;
    const field = element.dataset.field;
    
    element.classList.add('editing');
    element.innerHTML = `<input type="text" value="${currentValue}" id="edit-${field}" />`;
    
    const input = element.querySelector('input');
    input.focus();
    input.select();

    // Save on Enter key
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            saveField(element, field, input.value);
        }
    });

    // Save on blur (clicking outside)
    input.addEventListener('blur', () => {
        setTimeout(() => {
            if (element.classList.contains('editing')) {
                saveField(element, field, input.value);
            }
        }, 200);
    });

    // Cancel on Escape
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            element.classList.remove('editing');
            element.textContent = currentValue;
        }
    });
}

// Save field value
async function saveField(element, field, newValue) {
    const oldValue = currentProfile[field];
    
    // Trim value
    newValue = newValue.trim();

    // If no change, just restore
    if (newValue === oldValue || !newValue) {
        element.classList.remove('editing');
        element.textContent = oldValue;
        return;
    }

    // Validate based on field type
    if (field === 'email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(newValue)) {
            showSaveIndicator('‚ùå Invalid email format', true);
            element.classList.remove('editing');
            element.textContent = oldValue;
            return;
        }
    }

    if (field === 'phone' && newValue.length < 10) {
        showSaveIndicator('‚ùå Phone number too short', true);
        element.classList.remove('editing');
        element.textContent = oldValue;
        return;
    }

    // Show loading state
    element.textContent = 'Saving...';

    try {
        // Prepare update data
        const updateData = {
            fullName: field === 'fullName' ? newValue : currentProfile.fullName,
            email: field === 'email' ? newValue : currentProfile.email,
            phone: field === 'phone' ? newValue : currentProfile.phone
        };

        const res = await fetch(`${API_BASE}/api/customer/${userId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updateData)
        });

        const data = await res.json();

        if (!res.ok) {
            throw new Error(data.message || 'Update failed');
        }

        // Update current profile data
        currentProfile[field] = newValue;

        // Update display
        element.classList.remove('editing');
        element.textContent = newValue;

        // Update other places if name changed
        if (field === 'fullName') {
            document.getElementById('profileDisplayName').textContent = newValue;
            const initials = getInitials(newValue);
            document.getElementById('avatarInitials').textContent = initials;
            localStorage.setItem('fullname', newValue);
        }

        // Show success message
        showSaveIndicator('‚úì Saved successfully!');

    } catch (err) {
        console.error('Error saving field:', err);
        showSaveIndicator(`‚ùå ${err.message}`, true);
        element.classList.remove('editing');
        element.textContent = oldValue;
    }
}

// Show save indicator
function showSaveIndicator(message, isError = false) {
    const indicator = document.getElementById('saveIndicator');
    const messageSpan = document.getElementById('saveMessage');
    
    messageSpan.textContent = message;
    
    if (isError) {
        indicator.classList.add('error');
    } else {
        indicator.classList.remove('error');
    }
    
    indicator.classList.add('show');
    
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 3000);
}

// Load order statistics
async function loadOrderStats() {
    try {
        const res = await fetch(`${API_BASE}/api/customer/${userId}/orders`);
        
        if (!res.ok) {
            throw new Error('Failed to fetch orders');
        }
        
        const data = await res.json();
        const orders = data.orders || [];

        // Calculate statistics
        const totalOrders = orders.length;
        const activeOrders = orders.filter(o => 
            o.status !== 'completed' && o.status !== 'cancelled'
        ).length;
        const completedOrders = orders.filter(o => o.status === 'completed').length;

        // Update UI
        document.getElementById('totalOrders').textContent = totalOrders;
        document.getElementById('activeOrders').textContent = activeOrders;
        document.getElementById('completedOrders').textContent = completedOrders;
        
    } catch (err) {
        console.error('Error loading order stats:', err);
        // Keep default values (0) if error
    }
}

document.addEventListener('DOMContentLoaded', loadProfile);
</script>
</body>
</html>
